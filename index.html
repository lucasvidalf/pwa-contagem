
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2c7be5">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>InvDP</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/lucasvidalf/pwa-contagem/main/logo-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="https://raw.githubusercontent.com/lucasvidalf/pwa-contagem/main/logo-512.png">

  <style>
    /* ====================== CSS EMBUTIDO ====================== */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
    }

    /* Centraliza telas (login, menu, etc) */
    .centered-screen {
      display: flex;
      padding: 20px;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100%;
      box-sizing: border-box;
    }

    .container {
      background: #fff;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0px 4px 12px rgba(0,0,0,0.1);
      margin: 20px auto;
    }

    /* Elementos padr√µes */
    h1, h2, h3 { color: #2c7be5; }
    label {
      display: block;
      margin-top: 12px;
      text-align: left;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-top: 6px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 14px;
      margin-top: 15px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #2c7be5;
      color: #fff;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .msg { margin-top: 10px; font-weight: bold; }
    .sucesso { color: green; }
    .erro { color: red; }

    /* Tabelas */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }
    th { background: #eee; }

    footer {
      text-align: center;
      font-size: 12px;
      color: #888;
      margin: 15px 0;
    }

    /* Modal para mensagens */
    #modalOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(2px);
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #modalBox {
      background: white;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    #modalBotoes button {
      width: auto;
      min-width: 100px;
      margin: 8px;
      padding: 10px;
      font-size: 15px;
    }
    #modalBotoes .confirmar { background: #28a745; }
    #modalBotoes .cancelar { background: #dc3545; }
  </style>
</head>
<body>

  <!-- ====================== LOGIN ====================== -->
  <div id="loginBox" class="centered-screen">
    <div class="container">
      <h1>üîê Acesso</h1>
      <p>Digite seu c√≥digo de acesso</p>
      <input type="text" id="codigoLogin" placeholder="Digite seu c√≥digo">
      <button onclick="fazerLogin()">Entrar</button>
      <div class="msg" id="msgLogin"></div>
      <footer>Created by: Lucas Vidal</footer>
    </div>
  </div>

  <!-- ====================== MENU PRINCIPAL ====================== -->
  <div id="bemVindoBox" class="centered-screen" style="display:none;">
    <div class="container">
      <h1>‚úÖ Login realizado</h1>
      <p id="nomeUsuario"></p>
      <button onclick="abrirContagem(true)">üìã Abrir Nova Contagem</button>
      <button style="background:#ffc107;" onclick="menuContagensAbertas()">‚è≥ Contagens em Aberto</button>
      <button style="background:#17a2b8;" onclick="menuConsultas()">üîç Consultar Contagens Encerradas</button>
      <button style="background:#6c757d;" onclick="fazerLogout()">üö™ Sair</button>
    </div>
  </div>

  <!-- ====================== MODAL GEN√âRICO ====================== -->
  <div id="modalOverlay">
    <div id="modalBox">
      <h2 id="modalTitulo"></h2>
      <p id="modalMensagem"></p>
      <div id="modalBotoes"></div>
    </div>
  </div>

<script>
  /* ====================== CONFIGURA√á√ïES GERAIS ====================== */
  const API_URL = "https://script.google.com/macros/s/AKfycbweF6DIyx-vOxv8i7eVr4baeKtDbzk3IZEIs-aOTc99B8VYRezBKwW3RG2dd4Ee0XSuPQ/exec";
  let usuarioLogado = "";

  /* ====================== LOGIN (via fetch) ====================== */
  async function fazerLogin() {
    const codigo = document.getElementById('codigoLogin').value.trim();
    const msg = document.getElementById('msgLogin');

    if (!codigo) {
      msg.innerHTML = "<span class='erro'>‚ö†Ô∏è Digite seu c√≥digo!</span>";
      return;
    }

    msg.innerHTML = "‚è≥ Verificando...";

    try {
      // Agora usamos fetch ao inv√©s de google.script.run
      const response = await fetch(`${API_URL}?action=login&codigo=${codigo}`);
      const data = await response.json();

      if (data.sucesso) {
        usuarioLogado = data.nome;
        localStorage.setItem("usuarioLogado", usuarioLogado);
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('bemVindoBox').style.display = 'flex';
        document.getElementById('nomeUsuario').innerText = "Bem-vindo(a), " + data.nome + "!";
      } else {
        msg.innerHTML = "<span class='erro'>‚ùå C√≥digo inv√°lido!</span>";
      }
    } catch (err) {
      console.error(err);
      msg.innerHTML = "<span class='erro'>‚ùå Erro ao conectar ao servidor.</span>";
    }
  }

  /* ====================== LOGOUT ====================== */
  function fazerLogout() {
    usuarioLogado = "";
    localStorage.removeItem("usuarioLogado");

    document.getElementById('bemVindoBox').style.display = 'none';
    document.getElementById('loginBox').style.display = 'flex';
    document.getElementById('codigoLogin').value = "";
  }

  /* ====================== MODAL GEN√âRICO ====================== */
  function showModal(titulo, mensagem, tipo, callback) {
    document.getElementById('modalTitulo').innerHTML = titulo;
    document.getElementById('modalMensagem').innerHTML = mensagem;
    let botoesDiv = document.getElementById('modalBotoes');
    botoesDiv.innerHTML = "";

    if (tipo === 'confirm') {
      let btnConfirmar = document.createElement("button");
      btnConfirmar.innerText = "‚úÖ Confirmar";
      btnConfirmar.classList.add("confirmar");
      btnConfirmar.onclick = function() {
        fecharModal();
        if (callback) callback(true);
      };

      let btnCancelar = document.createElement("button");
      btnCancelar.innerText = "‚ùå Cancelar";
      btnCancelar.classList.add("cancelar");
      btnCancelar.onclick = function() {
        fecharModal();
        if (callback) callback(false);
      };

      botoesDiv.appendChild(btnConfirmar);
      botoesDiv.appendChild(btnCancelar);
    } else {
      let btnOk = document.createElement("button");
      btnOk.innerText = "OK";
      btnOk.onclick = fecharModal;
      botoesDiv.appendChild(btnOk);
    }

    document.getElementById('modalOverlay').style.display = 'flex';
  }

  function fecharModal() {
    document.getElementById('modalOverlay').style.display = 'none';
  }
   /* ====================== CARREGAR PRODUTOS ====================== */
  
  async function carregarProdutos() {
    try {
      const response = await fetch(`${API_URL}?action=getProdutos`);
      const produtos = await response.json();
  
      console.log("‚úÖ Produtos recebidos:", produtos);
      popularProdutos(produtos); // mesma fun√ß√£o que popula o select
    } catch (error) {
      console.error("‚ùå Erro ao carregar produtos:", error);
    }
  }
  
  /* ====================== CONTAGENS EM ABERTO (via fetch) ====================== */
  async function menuContagensAbertas() {
    showModal("‚è≥ Aguarde", "Carregando contagens em aberto...");
    try {
      const response = await fetch(`${API_URL}?action=listarContagensAbertas&filial=ADM`);
      const contagens = await response.json();
      console.log("Contagens abertas:", contagens);
      fecharModal();
      showModal("‚úÖ Sucesso", `Foram encontradas ${contagens.length} contagens abertas.`);
    } catch (e) {
      console.error(e);
      showModal("‚ùå Erro", "N√£o foi poss√≠vel carregar contagens abertas.");
    }
  }

  /* ====================== CONSULTAR ENCERRADAS ====================== */
  async function menuConsultas() {
    showModal("‚è≥ Aguarde", "Consultando contagens encerradas...");
    try {
      const response = await fetch(`${API_URL}?action=getBaseCSV&filial=ADM`);
      const registros = await response.json();
      fecharModal();
      showModal("‚úÖ Sucesso", `Foram carregados ${registros.length} registros da base.`);
    } catch (e) {
      console.error(e);
      showModal("‚ùå Erro", "Falha ao carregar registros encerrados.");
    }
  }
</script>
</body>
</html>

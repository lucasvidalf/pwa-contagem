<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2c7be5">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>InvDP</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/lucasvidalf/pwa-contagem/main/logo-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="https://raw.githubusercontent.com/lucasvidalf/pwa-contagem/main/logo-512.png">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif; background: #f4f4f4; }
    .centered-screen { display: flex; padding: 20px; justify-content: center; align-items: center; height: 100vh; width: 100%; box-sizing: border-box; }
    .container { background: #fff; padding: 20px; width: 90%; max-width: 500px; border-radius: 12px; text-align: center; box-shadow: 0px 4px 12px rgba(0,0,0,0.1); margin: 20px auto; }
    .fullscreen-scroll { display: flex; justify-content: center; align-items: center; width: 100%; }
    h1, h2, h3 { color: #2c7be5; }
    label { display: block; margin-top: 12px; text-align: left; font-weight: bold; }
    input, select, textarea { width: 100%; padding: 12px; font-size: 16px; margin-top: 6px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; -webkit-text-size-adjust: 100%; }
    button { width: 100%; padding: 14px; margin-top: 15px; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; background: #2c7be5; color: #fff; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .msg { margin-top: 10px; font-weight: bold; }
    .sucesso { color: green; }
    .erro { color: red; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 14px; }
    th { background: #eee; }
    footer { text-align: center; font-size: 12px; color: #888; margin: 15px 0; }
    #modalOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); align-items: center; justify-content: center; z-index: 9999; }
    #modalBox { background: white; padding: 20px; width: 90%; max-width: 400px; border-radius: 12px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
    #modalBox h2 { margin-top: 0; }
    #modalBotoes button { width: auto; min-width: 100px; margin: 8px; padding: 10px; font-size: 15px; }
    #modalBotoes .confirmar { background: #28a745; }
    #modalBotoes .cancelar { background: #dc3545; }
    .item-lancado { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #ddd; }
    .item-info { flex: 1; font-size: 14px; }
    .item-remove { color: red; cursor: pointer; font-weight: bold; margin-left: 10px; }
    #consultarBox .container { max-width: 900px !important; width: 95%; text-align: center; }
    #listaContagens > div { display: flex; justify-content: center; width: 100%; }
    #listaContagens table { width: 100%; max-width: 860px; border-collapse: collapse; font-size: 14px; background: #fff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); margin: 0 auto; }
    #listaContagens table th, #listaContagens table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    #listaContagens table thead tr { background: #f7f7f7; }
    #listaContagens table td:nth-child(4), #listaContagens table td:nth-child(5) { text-align: center; }
    #listaContagens { max-height: 450px; overflow-y: auto; overflow-x: auto; margin-top: 15px; }
    #listaContagens table th { position: sticky; top: 0; background: #f7f7f7; z-index: 1; }
    @media (max-width: 768px) { #consultarBox .container { max-width: 100% !important; padding: 10px; } #listaContagens { overflow-x: auto; } #listaContagens table { min-width: 700px; font-size: 13px; } }
  </style>
</head>
<body>
  <div id="loginBox" class="centered-screen">
    <div class="container">
      <h1>üîê Acesso</h1>
      <p>Digite seu c√≥digo de acesso</p>
      <input type="text" id="codigoLogin" placeholder="Digite seu c√≥digo">
      <button onclick="fazerLogin()">Entrar</button>
      <div class="msg" id="msgLogin"></div>
      <footer>Created by: Lucas Vidal</footer>
    </div>
  </div>
  <div id="bemVindoBox" class="centered-screen" style="display:none;">
    <div class="container">
      <h1>‚úÖ Login realizado</h1>
      <p id="nomeUsuario"></p>
      <button onclick="abrirContagem(true)">üìã Abrir Nova Contagem</button>
      <button style="background:#ffc107;" onclick="menuContagensAbertas()">‚è≥ Contagens em Aberto</button>
      <button style="background:#17a2b8;" onclick="menuConsultas()">üîç Consultar Contagens Encerradas</button>
      <button style="background:#6c757d;" onclick="fazerLogout()">üö™ Sair</button>
    </div>
  </div>
  <!-- ... resto do HTML omitido para brevidade ... -->
<script>
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxvBSz2Jq8GN6oTIdKZ1RsI_xfW80Mxr1B_oA_GDXknR1XrXnVFUA2zCfi0ss_yZkvWig/exec";
let usuarioLogado = "";
let produtosCarregados = [];

// === LOGIN VIA FETCH ===
async function fazerLogin() {
  const codigo = document.getElementById('codigoLogin').value.trim();
  const msg = document.getElementById('msgLogin');
  if (!codigo) { msg.innerHTML = "<span class='erro'>‚ö†Ô∏è Digite seu c√≥digo!</span>"; return; }
  msg.innerHTML = "‚è≥ Verificando...";
  try {
    const resp = await fetch(`${BACKEND_URL}?action=login&codigo=${codigo}`);
    const data = await resp.json();
    if (data.sucesso) {
      usuarioLogado = data.nome;
      document.getElementById('loginBox').style.display = 'none';
      document.getElementById('bemVindoBox').style.display = 'flex';
      document.getElementById('nomeUsuario').innerText = "Bem-vindo(a), " + data.nome + "!";
    } else { msg.innerHTML = "<span class='erro'>‚ùå C√≥digo inv√°lido!</span>"; }
  } catch(err){ msg.innerHTML = "<span class='erro'>‚ùå Erro ao conectar.</span>"; }
}

// === JSONP PARA PRODUTOS ===
function carregarProdutosJSONP() {
  const script = document.createElement('script');
  script.src = `${BACKEND_URL}?action=getProdutos&callback=handleProdutos`;
  document.body.appendChild(script);
}
function handleProdutos(data) {
  if (!Array.isArray(data)) { console.error("‚ö†Ô∏è Resposta inv√°lida", data); return; }
  produtosCarregados = data;
  console.log("‚úÖ Produtos recebidos via JSONP:", data);
  preencherSelects(data);
}

// === Preenche selects ===
function preencherSelects(lista) {
  const contSelect = document.getElementById("contagem");
  const datalist = document.getElementById("listaCodigos");
  contSelect.innerHTML = ""; datalist.innerHTML = "";
  [...new Set(lista.map(p=>p.contagem))].forEach(c=>{
    const opt=document.createElement("option"); opt.value=c; opt.textContent=c; contSelect.appendChild(opt);
  });
  lista.forEach(p=>{
    const opt=document.createElement("option"); opt.value=p.codigo; datalist.appendChild(opt);
  });
}

// === Abrir contagem ===
function abrirContagem(nova) {
  document.getElementById('bemVindoBox').style.display='none';
  document.getElementById('contagemBox').style.display='block';
  document.getElementById('usuarioContagem').innerText = usuarioLogado;
  document.getElementById('dataContagem').value = new Date().toLocaleDateString('pt-BR');
  carregarProdutosJSONP();
}

  const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxvBSz2Jq8GN6oTIdKZ1RsI_xfW80Mxr1B_oA_GDXknR1XrXnVFUA2zCfi0ss_yZkvWig/exec"; 
let produtosCarregados = [];

// Carrega os produtos via JSONP
function carregarProdutosJSONP() {
  const script = document.createElement("script");
  script.src = `${BACKEND_URL}?action=getProdutos&callback=handleProdutos`;
  document.body.appendChild(script);
}

// Essa fun√ß√£o ser√° chamada automaticamente pelo backend JSONP
function handleProdutos(data) {
  if (!Array.isArray(data)) {
    console.error("‚ö†Ô∏è Resposta inesperada do backend:", data);
    return;
  }

  produtosCarregados = data;
  console.log("‚úÖ Produtos recebidos:", produtosCarregados);

  preencherSelects(produtosCarregados);
}

// Preenche os selects com os produtos
function preencherSelects(lista) {
  const selectContagem = document.getElementById("selectContagem");
  const selectFilial = document.getElementById("selectFilial");
  const selectCodigo = document.getElementById("selectCodigo");

  selectContagem.innerHTML = `<option value="">Selecione...</option>`;
  selectFilial.innerHTML = `<option value="">Selecione...</option>`;
  selectCodigo.innerHTML = `<option value="">Selecione...</option>`;

  const contagensUnicas = [...new Set(lista.map(p => p.contagem).filter(Boolean))];
  const filiaisUnicas = [...new Set(lista.map(p => p.filial).filter(Boolean))];
  const codigosUnicos = [...new Set(lista.map(p => p.codigo).filter(Boolean))];

  contagensUnicas.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    selectContagem.appendChild(opt);
  });

  filiaisUnicas.forEach(f => {
    const opt = document.createElement("option");
    opt.value = f;
    opt.textContent = f;
    selectFilial.appendChild(opt);
  });

  codigosUnicos.forEach(cd => {
    const opt = document.createElement("option");
    opt.value = cd;
    opt.textContent = cd;
    selectCodigo.appendChild(opt);
  });
}

// Quando escolher c√≥digo ‚Üí preenche nome/almoxarifado
document.getElementById("selectCodigo").addEventListener("change", function() {
  const codigoSelecionado = this.value;
  const produto = produtosCarregados.find(p => p.codigo === codigoSelecionado);

  if (produto) {
    document.getElementById("nomeItem").value = produto.nome || "";
    document.getElementById("almoxarifado").value = produto.almoxarifado || "";
  }
});

// Ao abrir contagem, chama JSONP
function abrirContagem() {
  document.getElementById('bemVindoBox').style.display = 'none';
  document.getElementById('contagemBox').style.display = 'block';

  // sempre carrega os produtos via JSONP
  carregarProdutosJSONP();
}
  
</script>
</body>
</html>

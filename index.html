<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Contagem</title>
  <style>
    body { font-family: Arial; visibility: hidden; margin: 0; padding: 20px; background: #f4f4f4; }
    .box { display: none; }
    input, select { margin: 5px 0; display: block; width: 100%; }
    #listaItens { margin-top: 10px; }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginBox" class="box">
    <h2>Login</h2>
    <input id="codigoLogin" placeholder="C칩digo de usu치rio"/>
    <button onclick="fazerLogin()">Entrar</button>
  </div>

  <!-- Tela inicial -->
  <div id="bemVindoBox" class="box">
    <h2 id="nomeUsuario"></h2>
    <button onclick="abrirContagem(true)">Nova Contagem</button>
  </div>

  <!-- Contagem -->
  <div id="contagemBox" class="box">
    <h2>Contagem de Itens</h2>
    <div>Usu치rio: <span id="usuarioContagem"></span></div>
    <input id="dataContagem" readonly />
    <select id="contagem"></select>
    <input id="filial" placeholder="Filial" readonly/>
    <input id="almoxarifado" placeholder="Almoxarifado" readonly/>
    <input id="codigo" placeholder="C칩digo" list="listaCodigos"/>
    <datalist id="listaCodigos"></datalist>
    <input id="nomeItem" placeholder="Nome do item" readonly/>
    <button onclick="registrarItem()">Registrar</button>
    <div id="listaItens"></div>
    <button onclick="encerrarContagem()">Encerrar Contagem</button>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/SEU_ID/exec';
    let usuarioLogado = "";
    let produtosCarregados = [];
    let itensRegistrados = [];

    function salvarEstadoTela(tela) {
      const estado = {
        tela,
        usuarioLogado,
        itens: JSON.parse(JSON.stringify(itensRegistrados || [])),
        campos: {
          contagem: document.getElementById("contagem")?.value || "",
          filial: document.getElementById("filial")?.value || "",
          almoxarifado: document.getElementById("almoxarifado")?.value || "",
          data: document.getElementById("dataContagem")?.value || new Date().toLocaleDateString("pt-BR")
        },
        timestamp: Date.now()
      };
      localStorage.setItem("estadoTelaAtual", JSON.stringify(estado));
    }

    function mostrarBox(id) {
      document.querySelectorAll(".box").forEach(div => div.style.display = "none");
      document.getElementById(id).style.display = "block";
    }

    async function carregarProdutos() {
      try {
        const res = await fetch(`${API_URL}?action=getProdutos`);
        produtosCarregados = await res.json();
      } catch (e) {
        console.error("Erro ao carregar produtos:", e);
        produtosCarregados = [];
      }
    }

    function atualizarListaItens() {
      const lista = document.getElementById("listaItens");
      lista.innerHTML = "";
      itensRegistrados.forEach((item, index) => {
        const div = document.createElement("div");
        div.textContent = `${index + 1}. ${item.codigo} - ${item.nome} (${item.quantidade || 1})`;
        lista.appendChild(div);
      });
    }

    function preencherContagensDisponiveis() {
      const select = document.getElementById("contagem");
      const contagens = [...new Set(produtosCarregados.map(p => p.contagem).filter(Boolean))];
      select.innerHTML = "<option value=''>Selecione...</option>";
      contagens.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.innerText = c;
        select.appendChild(opt);
      });
    }

    function fazerLogin() {
      const codigo = document.getElementById("codigoLogin").value;
      if (!codigo.trim()) return;
      usuarioLogado = codigo;
      localStorage.setItem("usuarioLogado", usuarioLogado);
      iniciarApp();
    }

    async function abrirContagem(nova) {
      mostrarBox("contagemBox");
      document.getElementById("usuarioContagem").innerText = usuarioLogado;
      document.getElementById("dataContagem").value = new Date().toLocaleDateString("pt-BR");
      if (nova) {
        itensRegistrados = [];
        preencherContagensDisponiveis();
        atualizarListaItens();
      }
      salvarEstadoTela("contagem");
    }

    function registrarItem() {
      const codigo = document.getElementById("codigo").value;
      const nome = document.getElementById("nomeItem").value;
      if (!codigo || !nome) return;
      itensRegistrados.push({ codigo, nome, quantidade: 1 });
      atualizarListaItens();
      salvarEstadoTela("contagem");
      localStorage.setItem("itensTemporarios", JSON.stringify(itensRegistrados));
    }

    function encerrarContagem() {
      if (itensRegistrados.length === 0) return alert("Nada registrado.");
      localStorage.removeItem("itensTemporarios");
      localStorage.removeItem("estadoTelaAtual");
      alert("Contagem encerrada!");
      mostrarBox("bemVindoBox");
      salvarEstadoTela("menu");
    }

    // Eventos
    document.addEventListener("DOMContentLoaded", async () => {
      const estadoSalvo = localStorage.getItem("estadoTelaAtual");
      const usuario = localStorage.getItem("usuarioLogado");

      await carregarProdutos();

      if (usuario) {
        usuarioLogado = usuario;
        document.getElementById("nomeUsuario").innerText = "Bem-vindo(a), " + usuario + "!";

        if (estadoSalvo) {
          try {
            const estado = JSON.parse(estadoSalvo);
            if (estado.tela === "contagem") {
              mostrarBox("contagemBox");
              document.getElementById("usuarioContagem").innerText = usuario;
              document.getElementById("contagem").value = estado.campos.contagem;
              document.getElementById("filial").value = estado.campos.filial;
              document.getElementById("almoxarifado").value = estado.campos.almoxarifado;
              document.getElementById("dataContagem").value = estado.campos.data;

              const produtos = produtosCarregados.filter(p => p.contagem === estado.campos.contagem);
              const datalist = document.getElementById("listaCodigos");
              datalist.innerHTML = "";
              produtos.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.codigo;
                datalist.appendChild(opt);
              });

              itensRegistrados = estado.itens || [];
              atualizarListaItens();
              document.body.style.visibility = "visible";
              return;
            }
          } catch (e) {
            console.warn("Erro ao restaurar estado:", e);
          }
        }

        mostrarBox("bemVindoBox");
      } else {
        mostrarBox("loginBox");
      }

      document.body.style.visibility = "visible";
    });

    document.getElementById("contagem").addEventListener("change", () => {
      const selecionada = document.getElementById("contagem").value;
      const produtos = produtosCarregados.filter(p => p.contagem === selecionada);
      if (produtos.length > 0) {
        document.getElementById("filial").value = produtos[0].filial;
        document.getElementById("almoxarifado").value = produtos[0].almoxarifado;
        const datalist = document.getElementById("listaCodigos");
        datalist.innerHTML = "";
        produtos.forEach(p => {
          const opt = document.createElement("option");
          opt.value = p.codigo;
          datalist.appendChild(opt);
        });
      }
    });

    document.getElementById("codigo").addEventListener("input", () => {
      const codigoDigitado = document.getElementById("codigo").value.trim();
      const contagemSelecionada = document.getElementById("contagem").value;
      if (!codigoDigitado || !contagemSelecionada) {
        document.getElementById("nomeItem").value = "";
        return;
      }
      const produto = produtosCarregados.find(p => p.codigo === codigoDigitado && p.contagem === contagemSelecionada);
      document.getElementById("nomeItem").value = produto?.nome || "";
    });
  </script>
</body>
</html>
